<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Class LMS & Studio</title>
<style>
  /* =========================================
     å…±é€šãƒ»LMSç”¨ã‚¹ã‚¿ã‚¤ãƒ«
     ========================================= */
  :root { --primary: #005f73; --accent: #ee9b00; --bg: #f4f4f9; }
  body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background: var(--bg); color: #333; padding-top: 60px; /* Navi bar space */ }
  
  /* ãƒˆãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
  .main-nav {
    position: fixed; top: 0; left: 0; width: 100%; height: 50px;
    background: #333; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1000;
  }
  .nav-btn {
    background: transparent; border: none; color: #aaa; 
    padding: 0 20px; font-size: 16px; font-weight: bold; cursor: pointer; height: 100%;
    border-bottom: 3px solid transparent; transition: all 0.3s;
  }
  .nav-btn:hover { color: white; background: rgba(255,255,255,0.1); }
  .nav-btn.active { color: white; border-bottom: 3px solid var(--accent); }

  /* ã‚³ãƒ³ãƒ†ãƒŠè¡¨ç¤ºåˆ‡æ›¿ */
  .app-container { display: none; }
  .app-container.active { display: block; animation: fadeIn 0.3s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* LMSç”¨ãƒ‘ãƒ¼ãƒ„ */
  .lms-wrapper { max-width: 900px; margin: 20px auto; padding: 20px; }
  .card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 15px; }
  input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
  .btn-lms { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
  .btn-lms:hover { opacity: 0.9; }
  .btn-secondary { background: #7f8c8d; }
  .hidden { display: none; }
  .week-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
  .week-row:hover { background: #f0f8ff; }
  .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
  .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; }
  .tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
  .status-open { color: green; font-weight: bold; }

  /* =========================================
     å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ªç”¨ã‚¹ã‚¿ã‚¤ãƒ« (æä¾›ã‚³ãƒ¼ãƒ‰ã‚ˆã‚Šçµ±åˆ)
     ========================================= */
  .studio-wrapper {
      display: flex; flex-direction: column; align-items: center;
      width: 95%; max-width: 1200px; margin: 0 auto; padding: 20px 0; gap: 15px;
  }
  .studio-header {
      width: 100%; background-color: var(--primary); color: white;
      padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
      box-sizing: border-box; border-radius: 8px; margin-bottom: 10px;
  }
  /* Canvas & Video Area */
  .canvas-wrapper {
      position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      background: #000; border-radius: 8px; overflow: hidden;
      display: flex; justify-content: center; max-height: 60vh; width: 100%;
  }
  #studio-preview { display: block; max-width: 100%; max-height: 60vh; }
  #hidden-source-video, #studio-mixing-canvas, #editor-source-video { position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
  
  /* Controls */
  .studio-controls-panel {
      background: white; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px;
      justify-content: center; width: 100%; box-sizing: border-box;
  }
  .studio-btn {
      padding: 10px 16px; border: 1px solid #ccc; background: #f8f8f8;
      border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;
      display: flex; align-items: center; gap: 5px;
  }
  .studio-btn:hover { background: #e0e0e0; }
  .studio-btn.record-btn { background: #d00000; color: white; border-color: #b00000; }
  .studio-btn.record-btn.recording { background: white; color: #d00000; border: 2px solid #d00000; animation: pulse 1.5s infinite; }
  
  /* Editor Area */
  .editor-section { width: 100%; background: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; margin-top: 30px; }
  .editor-header { background: #e0f2f1; padding: 15px; border-bottom: 1px solid #b2dfdb; color: #00695c; margin: 0; }
  
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(208, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(208, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(208, 0, 0, 0); } }

/* å‹•ç”»ã‚’å›²ã£ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠï¼ˆdivãªã©ï¼‰ã¾ãŸã¯videoã‚¿ã‚°ã«é©ç”¨ */
.video-container {
    width: 100%;            /* æ¨ªå¹…ã„ã£ã±ã„ã«ã™ã‚‹ */
    max-width: 1200px;      /* å¿…è¦ã§ã‚ã‚Œã°æœ€å¤§å¹…ã‚’åˆ¶é™ */
    aspect-ratio: 16 / 9;   /* ä¸€èˆ¬çš„ãª16:9ã®æ¯”ç‡ã‚’ç¶­æŒã—ã¦é«˜ã•ã‚’è‡ªå‹•ç¢ºä¿ */
    margin: 0 auto;         /* ä¸­å¤®å¯„ã› */
    background-color: #000; /* èƒŒæ™¯ã‚’é»’ã«ã—ã¦æ˜ ç”»é¤¨ã£ã½ãã™ã‚‹ */
}

video {
    width: 100%;
    height: 100%;
    object-fit: contain;    /* å‹•ç”»ãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«æ å†…ã«åã‚ã‚‹ */
}
</style>
</head>
<body>

<nav class="main-nav">
  <button class="nav-btn active" onclick="switchApp('lms')" id="nav-lms">ğŸ“š è¬›ç¾©ã‚·ã‚¹ãƒ†ãƒ </button>
  <button class="nav-btn" onclick="switchApp('studio')" id="nav-studio" style="display:none;">ğŸ¥ å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ª</button>
</nav>

<div id="app-lms" class="app-container active">
  <div class="lms-wrapper">
    
   <div id="view-login" class="card">
  <div class="tabs">
    <div class="tab active" onclick="switchLoginTab('student')">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿ</div>
    <div class="tab" onclick="switchLoginTab('teacher')">ğŸ‘¨â€ğŸ« æ•™å“¡</div>
  </div>

  <div id="form-student-login">
    <h3>å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³</h3>
    <input type="email" id="stu-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="stu-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-lms" onclick="doStudentLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <hr>
    <button class="btn-lms btn-secondary" onclick="showStuRegForm()">æ–°è¦å­¦ç”Ÿç™»éŒ²ã¯ã“ã¡ã‚‰</button>
  </div>

  <div id="form-student-reg" class="hidden">
    <h3>ğŸ‘¨â€ğŸ“ å­¦ç”Ÿã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h3>
    <input type="text" id="stu-reg-name" placeholder="ãŠåå‰">
    <input type="email" id="stu-reg-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="stu-reg-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-lms" onclick="doStudentRegister()">ç™»éŒ²ã™ã‚‹</button>
    <button class="btn-lms btn-secondary" style="margin-top:5px;" onclick="hideStuRegForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <div id="form-teacher-login" class="hidden">
    <h3>æ•™å“¡ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <input type="email" id="tea-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="tea-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-lms" onclick="doTeacherLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <hr>
    <button class="btn-lms btn-secondary" onclick="showRegForm()">æ–°è¦æ•™å“¡ç™»éŒ²ã¯ã“ã¡ã‚‰</button>
  </div>
  
  <div id="form-teacher-reg" class="hidden">
    <h3>ğŸ‘¨â€ğŸ« æ•™å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</h3>
    <input type="text" id="reg-name" placeholder="ãŠåå‰">
    <input type="email" id="reg-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
    <input type="password" id="reg-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-lms" onclick="doTeacherRegister()">ç™»éŒ²ã™ã‚‹</button>
    <button class="btn-lms btn-secondary" style="margin-top:5px;" onclick="hideRegForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

    <div id="view-teacher-dash" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="teacher-name-display" style="margin:0;">å…ˆç”Ÿ</h2>
          <button class="btn-lms btn-secondary" style="width:auto;" onclick="location.reload()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
      
      <div class="card" style="background:#e8f6f3;">
        <h3>æ–°è¦è¬›ç¾©ã®ä½œæˆ</h3>
        <input type="text" id="new-course-id" placeholder="è¬›ç¾©ID (å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³ç”¨)">
        <input type="text" id="new-course-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³ç”¨)">
        <input type="text" id="new-course-name" placeholder="è¬›ç¾©å">
        <button class="btn-lms" onclick="doCreateCourse()">è¬›ç¾©ã‚’ä½œæˆ</button>
      </div>

      <h3>æ‹…å½“è¬›ç¾©ä¸€è¦§</h3>
      <div id="teacher-course-list"></div>
    </div>

    <div id="view-course-edit" class="hidden">
      <div class="card">
        <button class="btn-lms btn-secondary" style="width:auto; margin-bottom:10px;" onclick="backToTeacherDash()">â† æˆ»ã‚‹</button>
        <h2 id="edit-course-title" style="margin-top:0;">è¬›ç¾©ç·¨é›†</h2>
        <p>ç·¨é›†ã—ãŸã„å›ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div id="edit-lesson-list"></div>
      </div>
    </div>

    <div id="view-student-dash" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="student-name-display" style="margin:0;">å­¦ç”Ÿ</h2>
          <button class="btn-lms btn-secondary" style="width:auto;" onclick="location.reload()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>

      <div class="card" style="background:#fff3e0;">
        <h3>â• æ–°ã—ã„è¬›ç¾©ã‚’å±¥ä¿®ç™»éŒ²ã™ã‚‹</h3>
        <p style="font-size:0.9rem; margin-top:0;">å…ˆç”Ÿã‹ã‚‰æ•™ãˆã‚‰ã‚ŒãŸIDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <div style="display:flex; gap:10px;">
            <input type="text" id="join-course-id" placeholder="è¬›ç¾©ID" style="flex:1;">
            <input type="text" id="join-course-pass" placeholder="è¬›ç¾©ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="flex:1;">
        </div>
        <button class="btn-lms" onclick="doJoinCourse()">å±¥ä¿®ç™»éŒ²</button>
      </div>
      
      <div id="student-course-area">
          <h3>ğŸ“š å±¥ä¿®ä¸­ã®è¬›ç¾©</h3>
          <div id="student-my-courses"></div>
      </div>

      <div id="student-lesson-area" class="hidden">
          <button class="btn-lms btn-secondary" style="width:auto; margin-bottom:10px;" onclick="backToStudentDash()">â† è¬›ç¾©ä¸€è¦§ã«æˆ»ã‚‹</button>
          <h3 id="student-course-title"></h3>
          <div id="student-lesson-list" class="card"></div>
          
          <div id="student-quiz-area" class="card hidden">
            <h3 id="quiz-title"></h3>
            <div id="quiz-content"></div>
            <div id="quiz-result" style="margin-top:10px; font-weight:bold; font-size:1.2em;"></div>
          </div>
      </div>
    </div>



    <div id="view-teacher-dash" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="teacher-name-display" style="margin:0;">å…ˆç”Ÿ</h2>
          <button class="btn-lms btn-secondary" style="width:auto;" onclick="location.reload()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
      
      <div class="card" style="background:#e8f6f3;">
        <h3>æ–°è¦è¬›ç¾©ã®ä½œæˆ</h3>
        <input type="text" id="new-course-id" placeholder="è¬›ç¾©ID (å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³ç”¨)">
        <input type="text" id="new-course-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³ç”¨)">
        <input type="text" id="new-course-name" placeholder="è¬›ç¾©å">
        <button class="btn-lms" onclick="doCreateCourse()">è¬›ç¾©ã‚’ä½œæˆ</button>
      </div>

      <h3>æ‹…å½“è¬›ç¾©ä¸€è¦§</h3>
      <div id="teacher-course-list"></div>
    </div>

    <div id="view-course-edit" class="hidden">
      <div class="card">
        <button class="btn-lms btn-secondary" style="width:auto; margin-bottom:10px;" onclick="backToTeacherDash()">â† æˆ»ã‚‹</button>
        <h2 id="edit-course-title" style="margin-top:0;">è¬›ç¾©ç·¨é›†</h2>
        <p>ç·¨é›†ã—ãŸã„å›ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div id="edit-lesson-list"></div>
      </div>
    </div>

    <div id="view-quiz-editor" class="card hidden" style="border: 2px solid var(--accent); max-height: 90vh; overflow-y: auto;">
      <h3 style="margin-top:0;">ç¬¬ <span id="editor-week"></span> å›ï¼šèª²é¡Œè¨­å®š</h3>
      
      <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" id="editor-title" placeholder="ä¾‹ï¼šãƒã‚¤ã‚ªãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹åŸºç¤ãƒ†ã‚¹ãƒˆ">
      
      <label>å…¬é–‹é–‹å§‹æ—¥</label>
      <input type="date" id="editor-date">
      
      <hr style="margin: 20px 0;">
      <h4>ğŸ“ 4æŠã‚¯ã‚¤ã‚ºä½œæˆ</h4>
      
      <div id="questions-container"></div>

      <button class="btn-lms btn-secondary" onclick="addQuestionUI()" style="margin-bottom: 20px; border: 1px dashed #333; background: #f0f0f0; color: #333;">
        ï¼‹ å•é¡Œã‚’è¿½åŠ ã™ã‚‹
      </button>

      <div style="display:flex; gap:10px; border-top: 1px solid #ccc; padding-top: 15px;">
        <button class="btn-lms" onclick="doSaveLesson()">ä¿å­˜ã™ã‚‹</button>
        <button class="btn-lms btn-secondary" onclick="closeEditor()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <div id="view-student-dash" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="student-course-title" style="margin:0;">è¬›ç¾©</h2>
          <button class="btn-lms btn-secondary" style="width:auto;" onclick="location.reload()">çµ‚äº†</button>
        </div>
      </div>
      
      <h3>æˆæ¥­ä¸€è¦§</h3>
      <div id="student-lesson-list" class="card"></div>
      
      <div id="student-quiz-area" class="card hidden">
        <h3 id="quiz-title"></h3>
        <div id="quiz-content"></div>
        <div id="quiz-result" style="margin-top:10px; font-weight:bold; font-size:1.2em;"></div>
      </div>
    </div>
  </div></div><div id="app-studio" class="app-container">
  <div class="studio-wrapper">

    <div class="studio-header">
      <h2 style="margin:0; font-size:1.2rem;">ğŸ¥ æˆæ¥­å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ª</h2>
      <span style="font-size:0.8rem;">éŒ²ç”»ãƒ»ç·¨é›†ãƒ»ä¿å­˜</span>
    </div>

    <div style="width:100%; text-align:center; margin-bottom:10px;">
      <button class="studio-btn" style="background:linear-gradient(135deg, #7b1fa2, #ba68c8); color:white; font-weight:bold; padding:12px 30px; display:inline-flex;" onclick="startStudioScreenShare()">
        ğŸš€ ã‚¹ã‚¿ã‚¸ã‚ªã‚’é–‹å§‹ã™ã‚‹ (ç”»é¢é¸æŠ)
      </button>
      <p style="font-size:12px; color:#666; margin-top:5px;">â€» éŒ²ç”»é–‹å§‹å¾Œã€Previewãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éš ã™ã¨åˆã‚ã›é¡ã‚’é˜²ã’ã¾ã™ã€‚</p>
    </div>

    <div class="canvas-wrapper">
      <video id="studio-preview" playsinline muted autoplay></video>
      <div id="studio-rec-indicator" style="display:none; position:absolute; top:20px; right:20px; background:rgba(255,0,0,0.9); color:white; padding:5px 10px; border-radius:4px; font-weight:bold;">â— REC</div>
    </div>

    <div class="studio-controls-panel">
      <button class="studio-btn" id="btn-toggle-mic" onclick="toggleStudioMic()" disabled>ğŸ¤ Mic</button>
      <button class="studio-btn" id="btn-toggle-cam" onclick="toggleStudioCamera()" disabled>ğŸ“· Cam</button>
      <button class="studio-btn" id="btn-change-screen" onclick="changeScreenShare()">ğŸ”„ Change</button>
      <button class="studio-btn" id="btn-toggle-preview" onclick="toggleStudioPreview()">ğŸ¥ Preview</button>
      
      <div style="display:flex; align-items:center; gap:5px; margin:0 10px;">
        <span style="font-size:10px;">Mic Level</span>
        <div style="width:50px; height:6px; background:#555; border-radius:3px; overflow:hidden;">
          <div id="audio-level-bar" style="width:0%; height:100%; background:#00e676;"></div>
        </div>
      </div>

      <button class="studio-btn record-btn" id="btn-studio-record" onclick="toggleStudioRecording()" disabled>â— éŒ²ç”»é–‹å§‹</button>
      <button class="studio-btn" id="btn-studio-stop-stream" onclick="stopStudioStream()" style="display:none;">â¹ çµ‚äº†</button>
    </div>

    <div class="editor-section">
      <h3 class="editor-header">âœ‚ï¸ å‹•ç”»ç·¨é›† & ä¿å­˜</h3>
      <div style="padding:20px;">
        <input type="file" id="editor-file-input" accept="video/*" onchange="loadEditorVideo(this)">
        
        <div id="editor-controls" style="display:none; margin-top:20px;">
          <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; gap:10px; align-items:center;">
             <span>ãƒˆãƒªãƒŸãƒ³ã‚°(ç§’):</span>
             <input type="number" id="trim-start" value="0" step="0.1" style="width:60px;"> ï½ 
             <input type="number" id="trim-end" value="0" step="0.1" style="width:60px;">
             <button class="studio-btn" onclick="setTrimCurrent('start')">ç¾åœ¨åœ°ã‚’é–‹å§‹ã¸</button>
             <button class="studio-btn" onclick="setTrimCurrent('end')">ç¾åœ¨åœ°ã‚’çµ‚äº†ã¸</button>
          </div>

          <div style="margin-bottom:10px; display:flex; gap:10px;">
             <button class="studio-btn" id="btn-editor-mask" onclick="toggleEditorMaskMode()">â¬› é»’å¡—ã‚Šã‚¨ãƒªã‚¢æŒ‡å®š</button>
             <button class="studio-btn" onclick="undoEditorMask()">â†© 1ã¤æˆ»ã™</button>
             <button class="studio-btn" onclick="clearEditorMasks()">ğŸ—‘ï¸ å…¨æ¶ˆå»</button>
          </div>

          <div style="position:relative; background:black; display:inline-block; border:2px solid #333;">
            <canvas id="editor-canvas" style="max-width:100%; max-height:400px; display:block;"></canvas>
          </div>

          <div style="display:flex; align-items:center; gap:10px; margin-top:5px; background:#eee; padding:5px; border-radius:4px;">
             <span id="video-current-time" style="font-family:monospace;">00:00</span>
             <input type="range" id="video-seek-bar" value="0" step="0.1" style="flex:1;" oninput="onSeekEditor(this.value)">
             <span id="video-total-time" style="font-family:monospace;">00:00</span>
          </div>

          <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
             <button class="studio-btn" onclick="previewEditorVideo()" style="background:#0288d1; color:white;">â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
             <button class="studio-btn" onclick="stopEditorPreview()">â¸ åœæ­¢</button>
             <button class="studio-btn" id="btn-editor-export" onclick="startEditorExport()" style="background:#d32f2f; color:white; font-weight:bold;">ğŸ¬ å‹•ç”»ã‚’ä½œæˆãƒ»ä¿å­˜</button>
          </div>
          <p id="editor-status" style="text-align:center; color:#e65100; font-weight:bold; height:20px;"></p>
        </div>
      </div>
    </div>

    <div class="editor-section" style="margin-bottom:50px;">
      <h3 class="editor-header">ğŸ“š å‹•ç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜)</h3>
      <div id="video-library-list" style="padding:20px; display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px;">
        <p style="text-align:center; color:#999; width:100%;">ä¿å­˜ã•ã‚ŒãŸå‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“</p>
      </div>
    </div>

    <video id="hidden-source-video" playsinline muted autoplay></video>
    <canvas id="studio-mixing-canvas"></canvas>
    <video id="editor-source-video" playsinline muted></video>

  </div></div>

<script>
// ==========================================
// ğŸ”— GASé€£æºè¨­å®š (GitHubç”¨)
// ==========================================
// â†“ã“ã“ã«GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyg9Ja5I-RrLMp6rxRYsVj-EGj5AtihbaQE285wE_SyUOn5m6Ma_5vqD1L1ZNs5DuvzXQ/exec";

// GASã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®é–¢æ•° (fetchã‚’ä½¿ç”¨)
async function callGAS(action, params = {}) {
  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’FormDataå½¢å¼ã«å¤‰æ›
  const formData = new URLSearchParams();
  formData.append('action', action);
  for (const key in params) {
    formData.append(key, params[key]);
  }

  try {
    const response = await fetch(GAS_API_URL, {
      method: "POST",
      body: formData
    });
    const result = await response.json();
    return result;
  } catch (error) {
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error);
    return { success: false };
  }
}

// ==========================================
// ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
// ==========================================
function switchApp(appName) {

if (appName === 'studio') {
    // æ•™å“¡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ï¼ˆï¼æ•™å“¡ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ï¼‰å ´åˆã¯æ‹’å¦
    if (!currentTeacherEmail) {
      alert("âš ï¸ å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ªæ©Ÿèƒ½ã¯ã€æ•™å“¡ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«åˆ©ç”¨å¯èƒ½ã§ã™ã€‚");
      return; // ã“ã“ã§å‡¦ç†ã‚’ä¸­æ–­ã—ã€ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆãªã„
    }
  }

  document.querySelectorAll('.app-container').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
  
  document.getElementById('app-' + appName).classList.add('active');
  document.getElementById('nav-' + appName).classList.add('active');
}

// ==========================================
// ğŸ« LMS Logic (è¬›ç¾©ç®¡ç†)
// ==========================================
let currentTeacherEmail = "";
let currentCourseId = "";

function switchLoginTab(type) {
  // 1. ã‚¿ãƒ–ã®è¦‹ãŸç›®ã®åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
  event.target.classList.add('active');

  // 2. ä¸€æ—¦ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
  document.getElementById('form-student-login').classList.add('hidden');
  document.getElementById('form-student-reg').classList.add('hidden'); // å­¦ç”Ÿç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚‚éš ã™
  document.getElementById('form-teacher-login').classList.add('hidden');
  document.getElementById('form-teacher-reg').classList.add('hidden'); // æ•™å“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚‚éš ã™

  // 3. é¸ã°ã‚ŒãŸã‚¿ãƒ–ã®ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã€ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
  if(type === 'student') {
    document.getElementById('form-student-login').classList.remove('hidden');
  } else {
    document.getElementById('form-teacher-login').classList.remove('hidden');
  }
}

function showRegForm() {
  document.getElementById('form-teacher-login').classList.add('hidden');
  document.getElementById('form-teacher-reg').classList.remove('hidden');
}
function hideRegForm() {
  document.getElementById('form-teacher-reg').classList.add('hidden');
  document.getElementById('form-teacher-login').classList.remove('hidden');
}

// --- é€šä¿¡éƒ¨åˆ†ã‚’ callGAS ã«ç½®ãæ›ãˆ ---

async function doTeacherRegister() {
  const n = document.getElementById('reg-name').value;
  const e = document.getElementById('reg-email').value;
  const p = document.getElementById('reg-pass').value;
  if(!n || !e || !p) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
  const btn = event.target; btn.disabled = true; btn.innerText = "é€šä¿¡ä¸­...";

  const res = await callGAS('teacherRegister', {name: n, email: e, password: p});
  
  alert(res.message);
  if(res.success) hideRegForm();
  
  btn.disabled = false; btn.innerText = "ç™»éŒ²ã™ã‚‹";
}

async function doTeacherLogin() {
  const e = document.getElementById('tea-email').value;
  const p = document.getElementById('tea-pass').value;
  
  const btn = event.target; btn.disabled = true; btn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...";

  const res = await callGAS('teacherLogin', {email: e, password: p});
  
  if(res.success) {
    currentTeacherEmail = res.email;
    document.getElementById('teacher-name-display').innerText = res.name + " å…ˆç”Ÿ";
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-teacher-dash').classList.remove('hidden');
    loadTeacherCourses();

    // â–¼â–¼â–¼ è¿½åŠ ç®‡æ‰€: å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã•ã›ã‚‹ â–¼â–¼â–¼
    document.getElementById('nav-studio').style.display = 'block';
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

  } else {
    alert(res.message);
  }
  btn.disabled = false; btn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³";
}

async function loadTeacherCourses() {
  document.getElementById('teacher-course-list').innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";
  const res = await callGAS('getTeacherCourses', {email: currentTeacherEmail});
  
  const div = document.getElementById('teacher-course-list');
  div.innerHTML = "";
  if(res.success && res.list) {
    res.list.forEach(c => {
      div.innerHTML += `<div class="week-row">
        <span><b>${c.name}</b> (ID: ${c.id})</span>
        <button class="btn-lms btn-secondary" style="width:auto;" onclick="openCourseEdit('${c.id}', '${c.name}')">ç·¨é›†</button>
      </div>`;
    });
  }
}

async function doCreateCourse() {
  const id = document.getElementById('new-course-id').value;
  const pass = document.getElementById('new-course-pass').value;
  const name = document.getElementById('new-course-name').value;
  if(!id || !pass || !name) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  const res = await callGAS('createCourse', {email: currentTeacherEmail, id: id, pass: pass, name: name});
  alert(res.message);
  if(res.success) {
    document.getElementById('new-course-id').value = "";
    document.getElementById('new-course-pass').value = "";
    document.getElementById('new-course-name').value = "";
    loadTeacherCourses();
  }
}

async function openCourseEdit(id, name) {
  currentCourseId = id;
  document.getElementById('edit-course-title').innerText = name + " ã®ç·¨é›†";
  document.getElementById('view-teacher-dash').classList.add('hidden');
  document.getElementById('view-course-edit').classList.remove('hidden');
  document.getElementById('edit-lesson-list').innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>";
  
  const res = await callGAS('getLessonsForTeacher', {courseId: id});
  
  if(res.success) {
    const div = document.getElementById('edit-lesson-list');
    div.innerHTML = "";
    const lessons = res.lessons;
    for(let i=1; i<=15; i++) {
      const l = lessons[i];
      div.innerHTML += `<div class="week-row">
        <span>ç¬¬${i}å›: ${l.title || "ï¼ˆæœªè¨­å®šï¼‰"} <small style="color:#666;">${l.date ? "å…¬é–‹:" + l.date : ""}</small></span>
        <button class="btn-lms btn-secondary" style="width:auto; padding:5px 10px;" onclick='openLessonEditor(${i}, ${JSON.stringify(l)})'>è¨­å®š</button>
      </div>`;
    }
  }
}

function backToTeacherDash() {
  document.getElementById('view-course-edit').classList.add('hidden');
  document.getElementById('view-teacher-dash').classList.remove('hidden');
}

function openLessonEditor(week, data) {
  document.getElementById('view-quiz-editor').classList.remove('hidden');
  document.getElementById('view-course-edit').classList.add('hidden');
  
  document.getElementById('editor-week').innerText = week;
  document.getElementById('editor-week').dataset.week = week;
  document.getElementById('editor-title').value = data.title;
  document.getElementById('editor-date').value = data.date;

  // ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒªã‚»ãƒƒãƒˆ
  const container = document.getElementById('questions-container');
  container.innerHTML = "";

  // JSONã‚’è§£æã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆ
  let quizData = [];
  try {
    quizData = JSON.parse(data.quiz);
  } catch(e) {
    quizData = [];
  }

  // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã®åˆ†ã ã‘ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œã‚‹
  if (quizData.length > 0) {
    quizData.forEach(q => addQuestionUI(q));
  } else {
    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’1ã¤ä½œã£ã¦ãŠã
    addQuestionUI();
  }
}

// 2. å•é¡Œãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addQuestionUI(initialData = null) {
  const container = document.getElementById('questions-container');
  const index = container.children.length; // ä½•å•ç›®ã‹
  
  // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸå€¤è¨­å®š
  const text = initialData ? initialData.text : "";
  const opts = initialData ? initialData.options : ["", "", "", ""];
  const ans = initialData ? initialData.answer : 0;
  const exp = initialData ? initialData.explanation : "";

  const div = document.createElement('div');
  div.className = "question-item";
  div.style.cssText = "background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;";
  
  div.innerHTML = `
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
      <strong>å• ${index + 1}</strong>
      <button onclick="deleteQuestionUI(this)" style="background:#ef5350; color:white; border:none; padding:2px 8px; cursor:pointer; border-radius:4px; font-size:12px;">å‰Šé™¤</button>
    </div>
    <input type="text" class="q-text" placeholder="å•é¡Œæ–‡ã‚’å…¥åŠ›" value="${text}" style="margin-bottom:10px; font-weight:bold;">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
      <input type="text" class="q-opt0" placeholder="é¸æŠè‚¢ A" value="${opts[0]}">
      <input type="text" class="q-opt1" placeholder="é¸æŠè‚¢ B" value="${opts[1]}">
      <input type="text" class="q-opt2" placeholder="é¸æŠè‚¢ C" value="${opts[2]}">
      <input type="text" class="q-opt3" placeholder="é¸æŠè‚¢ D" value="${opts[3]}">
    </div>
    
    <label style="font-size:12px;">æ­£è§£:</label>
    <select class="q-ans" style="margin-bottom:10px;">
      <option value="0" ${ans == 0 ? "selected" : ""}>A</option>
      <option value="1" ${ans == 1 ? "selected" : ""}>B</option>
      <option value="2" ${ans == 2 ? "selected" : ""}>C</option>
      <option value="3" ${ans == 3 ? "selected" : ""}>D</option>
    </select>
    
    <label style="font-size:12px;">è§£èª¬:</label>
    <input type="text" class="q-exp" placeholder="æ­£è§£ã®ç†ç”±ã‚„è§£èª¬" value="${exp}">
  `;
  
  container.appendChild(div);
}

// 3. å•é¡Œãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
function deleteQuestionUI(btn) {
  if(!confirm("ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  btn.parentElement.parentElement.remove();
  
  // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™ï¼ˆè¦‹ãŸç›®ã ã‘ï¼‰
  const items = document.querySelectorAll('.question-item strong');
  items.forEach((item, idx) => {
    item.innerText = `å• ${idx + 1}`;
  });
}

// 4. ä¿å­˜å®Ÿè¡Œï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã¦JSONåŒ– â†’ GASã¸é€ä¿¡ï¼‰
async function doSaveLesson() {
  const week = document.getElementById('editor-week').dataset.week;
  const title = document.getElementById('editor-title').value;
  const date = document.getElementById('editor-date').value;
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‚’åé›†ã—ã¦é…åˆ—ã«ã™ã‚‹
  const qItems = document.querySelectorAll('.question-item');
  let questions = [];
  
  qItems.forEach(item => {
    const text = item.querySelector('.q-text').value;
    const opt0 = item.querySelector('.q-opt0').value;
    const opt1 = item.querySelector('.q-opt1').value;
    const opt2 = item.querySelector('.q-opt2').value;
    const opt3 = item.querySelector('.q-opt3').value;
    const ans = parseInt(item.querySelector('.q-ans').value);
    const exp = item.querySelector('.q-exp').value;
    
    // ç©ºæ¬„ã®å•é¡Œã¯ä¿å­˜ã—ãªã„ã‚ˆã†ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä»»æ„ï¼‰
    if(text) {
      questions.push({
        text: text,
        options: [opt0, opt1, opt2, opt3],
        answer: ans,
        explanation: exp
      });
    }
  });

  // é…åˆ—ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
  const jsonString = JSON.stringify(questions);
  
  const btn = event.target; 
  btn.disabled = true; 
  btn.innerText = "ä¿å­˜ä¸­...";
  
  // GASã¸é€ä¿¡
  const res = await callGAS('saveLessonData', {
    courseId: currentCourseId, 
    week: week, 
    title: title, 
    date: date, 
    json: jsonString // è‡ªå‹•ç”Ÿæˆã—ãŸJSONã‚’é€ã‚‹
  });
  
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  closeEditor();
  openCourseEdit(currentCourseId, document.getElementById('edit-course-title').innerText);
  
  btn.disabled = false; 
  btn.innerText = "ä¿å­˜ã™ã‚‹";
}

function closeEditor() {
  document.getElementById('view-quiz-editor').classList.add('hidden');
  document.getElementById('view-course-edit').classList.remove('hidden');
}

async function doSaveLesson() {
  const week = document.getElementById('editor-week').dataset.week;
  const title = document.getElementById('editor-title').value;
  const date = document.getElementById('editor-date').value;
  const json = document.getElementById('editor-json').value;
  
  const btn = event.target; btn.disabled = true; btn.innerText = "ä¿å­˜ä¸­...";
  
  const res = await callGAS('saveLessonData', {
    courseId: currentCourseId, week: week, title: title, date: date, json: json
  });
  
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  closeEditor();
  openCourseEdit(currentCourseId, document.getElementById('edit-course-title').innerText);
  btn.disabled = false; btn.innerText = "ä¿å­˜ã™ã‚‹";
}

// ==========================================
// ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç”¨ãƒ­ã‚¸ãƒƒã‚¯ (æ–°è¦ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãƒ»å±¥ä¿®)
// ==========================================
let currentStudentEmail = "";

// ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨
function showStuRegForm() {
  document.getElementById('form-student-login').classList.add('hidden');
  document.getElementById('form-student-reg').classList.remove('hidden');
}
function hideStuRegForm() {
  document.getElementById('form-student-reg').classList.add('hidden');
  document.getElementById('form-student-login').classList.remove('hidden');
}
function backToStudentDash() {
  document.getElementById('student-lesson-area').classList.add('hidden');
  document.getElementById('student-course-area').classList.remove('hidden');
}

// 1. å­¦ç”Ÿæ–°è¦ç™»éŒ²
async function doStudentRegister() {
  const n = document.getElementById('stu-reg-name').value;
  const e = document.getElementById('stu-reg-email').value;
  const p = document.getElementById('stu-reg-pass').value;
  if(!n || !e || !p) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  const btn = event.target; btn.disabled = true; btn.innerText = "é€šä¿¡ä¸­...";

  // GASå´ã® 'studentRegister' ã‚’å‘¼ã¶
  const res = await callGAS('studentRegister', {name: n, email: e, password: p});
  
  alert(res.message);
  if(res.success) hideStuRegForm();
  
  btn.disabled = false; btn.innerText = "ç™»éŒ²ã™ã‚‹";
}

// 2. å­¦ç”Ÿãƒ­ã‚°ã‚¤ãƒ³
async function doStudentLogin() {
  const e = document.getElementById('stu-email').value;
  const p = document.getElementById('stu-pass').value;
  
  const btn = event.target; btn.disabled = true; btn.innerText = "ç¢ºèªä¸­...";
  
  // GASå´ã® 'studentLogin' ã‚’å‘¼ã¶ (å¼•æ•°ã‚’IDã‹ã‚‰Emailã«å¤‰æ›´)
  const res = await callGAS('studentLogin', {email: e, password: p});
  
  if(res.success) {
    currentStudentEmail = res.email;
    document.getElementById('student-name-display').innerText = res.name + " ã•ã‚“";
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-student-dash').classList.remove('hidden');
    
    // å±¥ä¿®è¬›ç¾©ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    loadMyCourses();
  } else {
    alert(res.message);
  }
  btn.disabled = false; btn.innerText = "ãƒ­ã‚°ã‚¤ãƒ³";
}

// 3. å±¥ä¿®è¬›ç¾©ä¸€è¦§ã®å–å¾—
async function loadMyCourses() {
  const div = document.getElementById('student-my-courses');
  div.innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";
  
  const res = await callGAS('getStudentCourses', {email: currentStudentEmail});
  
  div.innerHTML = "";
  if(res.success && res.list && res.list.length > 0) {
    res.list.forEach(c => {
      div.innerHTML += `
        <div class="week-row" style="cursor:pointer;" onclick="openStudentCourse('${c.id}', '${c.name}')">
          <span>ğŸ“– <b>${c.name}</b></span>
          <button class="btn-lms btn-secondary" style="width:auto; padding:5px;">å…¥å®¤</button>
        </div>`;
    });
  } else {
    div.innerHTML = "<p>å±¥ä¿®ã—ã¦ã„ã‚‹è¬›ç¾©ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>";
  }
}

// 4. æ–°ã—ã„è¬›ç¾©ã‚’å±¥ä¿®ç™»éŒ²ã™ã‚‹
async function doJoinCourse() {
  const id = document.getElementById('join-course-id').value;
  const pass = document.getElementById('join-course-pass').value;
  if(!id || !pass) return alert("è¬›ç¾©IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const btn = event.target; btn.disabled = true; btn.innerText = "ç™»éŒ²ä¸­...";

  const res = await callGAS('joinCourse', {
      email: currentStudentEmail, 
      courseId: id, 
      coursePass: pass
  });

  alert(res.message);
  if(res.success) {
      document.getElementById('join-course-id').value = "";
      document.getElementById('join-course-pass').value = "";
      loadMyCourses(); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
  }
  btn.disabled = false; btn.innerText = "å±¥ä¿®ç™»éŒ²";
}

// 5. è¬›ç¾©ã‚’é¸æŠã—ã¦æˆæ¥­ä¸€è¦§ã‚’è¡¨ç¤º
async function openStudentCourse(courseId, courseName) {
  document.getElementById('student-course-area').classList.add('hidden');
  document.getElementById('student-lesson-area').classList.remove('hidden');
  document.getElementById('student-course-title').innerText = courseName;
  
  // æ—¢å­˜ã® loadStudentLessons ã‚’å†åˆ©ç”¨ï¼ˆå¼•æ•°ã‚’æ¸¡ã™ã‚ˆã†ã«å°‘ã—ä¿®æ­£ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰
  await loadStudentLessons(courseId);
}

// æ—¢å­˜ã® loadStudentLessons ã‚’ã€å¼•æ•°(id)ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„
async function loadStudentLessons(id) {
  document.getElementById('student-lesson-list').innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";
  document.getElementById('student-quiz-area').classList.add('hidden'); // ã‚¯ã‚¤ã‚ºç”»é¢ã‚’éš ã™

  const res = await callGAS('getLessonsForStudent', {id: id});
  
  const div = document.getElementById('student-lesson-list');
  div.innerHTML = "";
  if(res.success) {
    const list = res.list;
    if(list.length === 0) div.innerHTML = "<p>ç¾åœ¨å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æˆæ¥­ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    list.forEach(l => {
      if(l.isOpen) {
        div.innerHTML += `<div class="week-row" style="cursor:pointer; border-left:5px solid green;" onclick='startQuiz(${JSON.stringify(l)})'>
          <div><span class="status-open">â— ç¬¬${l.week}å›</span> <b>${l.title}</b></div>
          <button class="btn-lms" style="width:auto;">èª²é¡Œã¸</button>
        </div>`;
      } else {
        div.innerHTML += `<div class="week-row" style="background:#eee; color:#999;">
          <div>ğŸ”’ ç¬¬${l.week}å› ${l.title || ""}</div><small>å…¬é–‹æ—¥: ${l.openDateStr}</small>
        </div>`;
      }
    });
  }
}


function startQuiz(lessonData) {
  const area = document.getElementById('student-quiz-area');
  area.classList.remove('hidden');
  area.scrollIntoView({behavior:'smooth'});
  document.getElementById('quiz-title').innerText = `ç¬¬${lessonData.week}å›: ${lessonData.title}`;
  const content = document.getElementById('quiz-content');
  const result = document.getElementById('quiz-result');
  result.innerText = "";
  let quiz = [];
  try { quiz = JSON.parse(lessonData.quiz); } catch(e) {}
  if(!quiz || quiz.length === 0) {
    content.innerHTML = "èª²é¡Œè¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return;
  }
  let html = "";
  quiz.forEach((q, i) => {
    let opts = "";
    q.options.forEach((o, oid) => {
      opts += `<label style="display:block; padding:5px;"><input type="radio" name="q${i}" value="${oid}"> ${o}</label>`;
    });
    html += `<div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
      <b>Q${i+1}. ${q.text}</b><div>${opts}</div><div id="fb-${i}" style="font-size:0.9em; margin-top:5px;"></div>
    </div>`;
  });
  html += `<button class="btn-lms" onclick='checkQuiz(${JSON.stringify(quiz)})'>æ¡ç‚¹ã™ã‚‹</button>`;
  content.innerHTML = html;
}

function checkQuiz(quizData) {
  let score = 0;
  quizData.forEach((q, i) => {
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    const fb = document.getElementById(`fb-`+i);
    if(sel && parseInt(sel.value) === q.answer) {
      score++;
      fb.innerHTML = `<span style="color:green">â­• æ­£è§£ï¼</span> ${q.explanation}`;
    } else {
      fb.innerHTML = `<span style="color:red">âŒ ä¸æ­£è§£...</span> ${q.explanation}`;
    }
  });
  document.getElementById('quiz-result').innerText = `å¾—ç‚¹: ${score} / ${quizData.length} ç‚¹`;
}

// ==========================================
// ğŸ¥ Studio Logic (å‹•ç”»ç·¨é›†)
// ==========================================
let studioStream = null, webcamStream = null, studioMixedStream = null, studioRecorder = null;
let studioChunks = [], isStudioRecording = false, studioAnimId = null, audioContext = null, studioMicNode = null;
let isWebcamVisible = true, isMicMuted = false;
const studioPreview = document.getElementById('studio-preview');
const hiddenSourceVideo = document.getElementById('hidden-source-video');
const mixingCanvas = document.getElementById('studio-mixing-canvas');
const mixingCtx = mixingCanvas ? mixingCanvas.getContext('2d') : null;
const levelBar = document.getElementById('audio-level-bar');

async function startStudioScreenShare() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        alert("ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return;
    }
    try {
        const userStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { width:320, height:240 } });
        webcamStream = new MediaStream(userStream.getVideoTracks());
        const micStream = new MediaStream(userStream.getAudioTracks());
        studioStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: true });
        
        hiddenSourceVideo.srcObject = studioStream;
        await hiddenSourceVideo.play();
        mixingCanvas.width = hiddenSourceVideo.videoWidth; mixingCanvas.height = hiddenSourceVideo.videoHeight;
        
        const mixedAudio = await mixAudioStreams(micStream, studioStream);
        const canvasStream = mixingCanvas.captureStream(30);
        if(mixedAudio.length > 0) canvasStream.addTrack(mixedAudio[0]);
        
        studioMixedStream = canvasStream;
        studioPreview.srcObject = studioMixedStream;
        drawStudioFrame();
        updateStudioUI(true);
        initAudioMeter(micStream);
        studioStream.getVideoTracks()[0].onended = () => stopStudioStream();
    } catch (err) { alert("èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message); }
}

function drawStudioFrame() {
    if (!studioStream || !studioStream.active) return;
    if (mixingCanvas.width !== hiddenSourceVideo.videoWidth) {
        mixingCanvas.width = hiddenSourceVideo.videoWidth; mixingCanvas.height = hiddenSourceVideo.videoHeight;
    }
    mixingCtx.drawImage(hiddenSourceVideo, 0, 0, mixingCanvas.width, mixingCanvas.height);
    if (isWebcamVisible && webcamStream) {
        if (!window.tempWebcamVideo) {
            window.tempWebcamVideo = document.createElement('video');
            window.tempWebcamVideo.srcObject = webcamStream; window.tempWebcamVideo.muted = true; window.tempWebcamVideo.play();
        }
        const w = mixingCanvas.width * 0.2; const h = (w/4)*3;
        const x = mixingCanvas.width - w - 20; const y = mixingCanvas.height - h - 20;
        mixingCtx.save(); mixingCtx.beginPath(); mixingCtx.arc(x+w/2, y+h/2, h/2, 0, Math.PI*2); mixingCtx.clip();
        mixingCtx.drawImage(window.tempWebcamVideo, x, y, w, h);
        mixingCtx.strokeStyle = "white"; mixingCtx.lineWidth = 5; mixingCtx.stroke(); mixingCtx.restore();
    }
    studioAnimId = requestAnimationFrame(drawStudioFrame);
}

async function mixAudioStreams(mic, sys) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const dest = audioContext.createMediaStreamDestination();
    if(mic.getAudioTracks().length > 0) {
        const src = audioContext.createMediaStreamSource(mic);
        studioMicNode = audioContext.createGain(); studioMicNode.gain.value = 1.5;
        src.connect(studioMicNode).connect(dest);
    }
    if(sys.getAudioTracks().length > 0) {
        const src = audioContext.createMediaStreamSource(sys);
        src.connect(audioContext.createGain()).connect(dest);
    }
    return dest.stream.getAudioTracks();
}

function initAudioMeter(stream) {
    if(!audioContext) return;
    const analyser = audioContext.createAnalyser(); analyser.fftSize = 256;
    audioContext.createMediaStreamSource(stream).connect(analyser);
    const buf = new Uint8Array(analyser.frequencyBinCount);
    const update = () => {
        if(!studioStream || !studioStream.active) return;
        analyser.getByteFrequencyData(buf);
        let sum = 0; for(let i=0; i<buf.length; i++) sum+=buf[i];
        const vol = isMicMuted ? 0 : Math.min(100, (sum/buf.length)*2);
        if(levelBar) levelBar.style.width = vol + "%";
        requestAnimationFrame(update);
    };
    update();
}

function toggleStudioMic() {
    isMicMuted = !isMicMuted;
    if(studioMicNode) studioMicNode.gain.value = isMicMuted ? 0 : 1.5;
    document.getElementById('btn-toggle-mic').innerHTML = isMicMuted ? "ğŸ”‡ Mic" : "ğŸ¤ Mic";
}
function toggleStudioCamera() { isWebcamVisible = !isWebcamVisible; }
function toggleStudioPreview() { studioPreview.style.opacity = studioPreview.style.opacity==='0'?'1':'0'; }
function updateStudioUI(isActive) {
    ['btn-toggle-mic','btn-toggle-cam','btn-change-screen','btn-studio-record'].forEach(id=>{
        document.getElementById(id).disabled = !isActive;
    });
    document.getElementById('btn-studio-stop-stream').style.display = isActive ? 'inline-block' : 'none';
}
function toggleStudioRecording() {
    if(!isStudioRecording) {
        studioChunks = []; studioRecorder = new MediaRecorder(studioMixedStream, {mimeType:'video/webm;codecs=vp9'});
        studioRecorder.ondataavailable = e => { if(e.data.size>0) studioChunks.push(e.data); };
        studioRecorder.onstop = saveStudioVideo;
        studioRecorder.start(); isStudioRecording = true;
        document.getElementById('btn-studio-record').classList.add('recording');
        document.getElementById('studio-rec-indicator').style.display='block';
    } else {
        studioRecorder.stop(); isStudioRecording = false;
        document.getElementById('btn-studio-record').classList.remove('recording');
        document.getElementById('studio-rec-indicator').style.display='none';
    }
}
function saveStudioVideo() {
    const blob = new Blob(studioChunks, {type:'video/webm'});
    const url = URL.createObjectURL(blob);
    if(confirm("å‹•ç”»ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) saveVideoToDB(blob, `Rec_${new Date().toLocaleTimeString()}`);
}
function stopStudioStream() {
    if(studioStream) studioStream.getTracks().forEach(t=>t.stop());
    if(webcamStream) webcamStream.getTracks().forEach(t=>t.stop());
    if(audioContext) audioContext.close();
    if(studioAnimId) cancelAnimationFrame(studioAnimId);
    studioPreview.srcObject = null; updateStudioUI(false);
}

// Editor & Library
let editorVideo = document.getElementById('editor-source-video');
let editorCanvas = document.getElementById('editor-canvas');
let editorCtx = editorCanvas ? editorCanvas.getContext('2d') : null;
let isEditorPreviewing = false, editorMasks = [], isMasking = false, maskStart = null, isExporting = false;

async function changeScreenShare() {
    try {
        // 1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ç”»é¢é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å†åº¦é–‹ã
        const newStream = await navigator.mediaDevices.getDisplayMedia({ 
            video: { cursor: "always" }, 
            audio: true 
        });

        // 2. ç¾åœ¨ã®å¤ã„ç”»é¢å…±æœ‰ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã™ã‚‹ï¼ˆè£ã§å‹•ãç¶šã‘ãªã„ã‚ˆã†ã«ï¼‰
        if (studioStream) {
            studioStream.getVideoTracks().forEach(track => track.stop());
        }

        // 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æ›´æ–°
        studioStream = newStream;

        // 4. æ˜ åƒã‚½ãƒ¼ã‚¹ï¼ˆéš ã—ãƒ“ãƒ‡ã‚ªã‚¿ã‚°ï¼‰ã‚’æ–°ã—ã„ã‚‚ã®ã«å·®ã—æ›¿ãˆã‚‹
        const hiddenVideo = document.getElementById('hidden-source-video');
        hiddenVideo.srcObject = studioStream;
        await hiddenVideo.play();

        // 5. æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã‚‚ã€Œå…±æœ‰ã‚’åœæ­¢ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰çµ‚äº†ã™ã‚‹ã‚ˆã†ã«è¨­å®š
        studioStream.getVideoTracks()[0].onended = () => stopStudioStream();

        console.log("ç”»é¢å…±æœ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");

    } catch (err) {
        console.log("ç”»é¢å¤‰æ›´ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err);
    }
}


function loadEditorVideo(input) {
    const file = input.files[0]; if(!file) return;
    editorVideo.src = URL.createObjectURL(file);
    editorVideo.onloadedmetadata = () => {
        document.getElementById('editor-controls').style.display = 'block';
        document.getElementById('trim-end').value = editorVideo.duration.toFixed(1);
        document.getElementById('video-seek-bar').max = editorVideo.duration;
        updateEditorCanvas();
    };
    editorVideo.oncanplay = () => { editorVideo.currentTime = 0; drawEditorFrame(); editorVideo.oncanplay=null; };
    editorVideo.onseeked = () => drawEditorFrame();
}
function onSeekEditor(v) { if(isEditorPreviewing) stopEditorPreview(); editorVideo.currentTime=v; drawEditorFrame(); }
function updateEditorCanvas() { editorCanvas.width = 1280; editorCanvas.height = 720; drawEditorFrame(); }
function drawEditorFrame() {
    if(!editorCtx || !editorVideo.videoWidth) return;
    editorCtx.fillStyle='#000'; editorCtx.fillRect(0,0,editorCanvas.width,editorCanvas.height);
    const s = Math.min(editorCanvas.width/editorVideo.videoWidth, editorCanvas.height/editorVideo.videoHeight);
    const w = editorVideo.videoWidth*s; const h = editorVideo.videoHeight*s;
    editorCtx.drawImage(editorVideo, (editorCanvas.width-w)/2, (editorCanvas.height-h)/2, w, h);
    editorCtx.fillStyle='#000'; editorMasks.forEach(m=>editorCtx.fillRect(m.x,m.y,m.w,m.h));
    document.getElementById('video-current-time').textContent = editorVideo.currentTime.toFixed(1);
}
function previewEditorVideo() {
    stopEditorPreview(); isEditorPreviewing = true;
    const end = parseFloat(document.getElementById('trim-end').value);
    editorVideo.currentTime = parseFloat(document.getElementById('trim-start').value);
    editorVideo.play();
    const loop = () => {
        if(!isEditorPreviewing) return;
        if(editorVideo.currentTime >= end || editorVideo.ended) stopEditorPreview();
        drawEditorFrame(); requestAnimationFrame(loop);
    }; loop();
}
function stopEditorPreview() { isEditorPreviewing = false; editorVideo.pause(); }
function setTrimCurrent(t) { document.getElementById('trim-'+t).value = editorVideo.currentTime.toFixed(1); }

// Masking
function toggleEditorMaskMode() {
    isMasking = !isMasking;
    const c = editorCanvas;
    if(isMasking) {
        c.style.cursor = 'crosshair';
        c.addEventListener('mousedown', onMaskDown);
        c.addEventListener('mouseup', onMaskUp);
    } else {
        c.style.cursor = 'default';
        c.removeEventListener('mousedown', onMaskDown);
        c.removeEventListener('mouseup', onMaskUp);
    }
}
function onMaskDown(e) { maskStart = getPos(e); }
function onMaskUp(e) {
    if(!maskStart) return;
    const end = getPos(e);
    editorMasks.push({ x: Math.min(maskStart.x,end.x), y: Math.min(maskStart.y,end.y), w: Math.abs(end.x-maskStart.x), h: Math.abs(end.y-maskStart.y) });
    maskStart = null; drawEditorFrame();
}
function getPos(e) {
    const r = editorCanvas.getBoundingClientRect();
    return { x: (e.clientX-r.left)*(editorCanvas.width/r.width), y: (e.clientY-r.top)*(editorCanvas.height/r.height) };
}
function undoEditorMask() { editorMasks.pop(); drawEditorFrame(); }
function clearEditorMasks() { editorMasks=[]; drawEditorFrame(); }

// Export
function startEditorExport() {
    if(isExporting) return; isExporting = true;
    const start = parseFloat(document.getElementById('trim-start').value);
    const end = parseFloat(document.getElementById('trim-end').value);
    const btn = document.getElementById('btn-editor-export'); btn.disabled=true;
    const stream = editorCanvas.captureStream(30);
    const rec = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});
    const chunks = [];
    rec.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
    rec.onstop = () => {
        const blob = new Blob(chunks, {type:'video/webm'});
        if(confirm("ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) saveVideoToDB(blob, `Edit_${new Date().toLocaleTimeString()}`);
        document.getElementById('editor-status').textContent = "å®Œäº†";
        btn.disabled=false; isExporting=false;
    };
    rec.start(); editorVideo.currentTime = start; editorVideo.play();
    const loop = () => {
        if(!isExporting) return;
        drawEditorFrame();
        if(editorVideo.currentTime >= end) { editorVideo.pause(); rec.stop(); return; }
        document.getElementById('editor-status').textContent = `ä½œæˆä¸­... ${Math.round(((editorVideo.currentTime-start)/(end-start))*100)}%`;
        requestAnimationFrame(loop);
    }; loop();
}

// DB
const DB_NAME='LMS_Studio_DB', STORE_NAME='videos'; let db=null;
const req = indexedDB.open(DB_NAME, 1);
req.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME, {keyPath:'id', autoIncrement:true}); };
req.onsuccess = e => { db = e.target.result; loadVideosFromDB(); };
function saveVideoToDB(blob, title) {
    if(!db) return;
    db.transaction([STORE_NAME],'readwrite').objectStore(STORE_NAME).add({title:title, blob:blob, date:new Date().toLocaleString(), size:(blob.size/1024/1024).toFixed(2)+'MB'}).onsuccess = loadVideosFromDB;
}

function loadVideosFromDB() {
    if (!db) return;
    const div = document.getElementById('video-library-list');
    div.innerHTML = "";
    db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).openCursor(null, 'prev').onsuccess = e => {
        const c = e.target.result;
        if (c) {
            const v = c.value;
            // ã‚­ãƒ¼ï¼ˆIDï¼‰ã‚’å–å¾—ã€‚keyPath: 'id' ãªã®ã§ v.id ã¾ãŸã¯ c.primaryKey ã§å–å¾—å¯èƒ½
            const key = c.primaryKey; 
            const url = URL.createObjectURL(v.blob);
            
            div.innerHTML += `<div class="card" style="padding:10px; display:flex; flex-direction:column; gap:5px;">
                <video src="${url}" controls style="width:100%; height:auto; max-height:200px; background:#000; border-radius:4px;"></video>
                <div style="font-size:0.8rem; font-weight:bold; margin-top:5px;">${v.title}</div>
                <div style="font-size:0.7rem; color:#666;">${v.date} (${v.size})</div>
                
                <div style="display:flex; gap:5px; margin-top:auto;">
                  <a href="${url}" download="${v.title}.webm" class="studio-btn" style="flex:1; justify-content:center; text-decoration:none; color:#333; font-size:12px;">ğŸ’¾ DL</a>
                  <button class="studio-btn" style="flex:1; justify-content:center; font-size:12px;" onclick="loadToEditorFromLib('${url}')">âœ‚ï¸ ç·¨é›†</button>
                  <button class="studio-btn" style="flex:1; justify-content:center; font-size:12px; background:#ffebee; color:#c62828; border-color:#ffcdd2;" onclick="deleteVideoFromDB(${key})">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            </div>`;
            c.continue();
        }
    };
}

function deleteVideoFromDB(id) {
    if (!confirm("æœ¬å½“ã«ã“ã®å‹•ç”»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;

    const tx = db.transaction([STORE_NAME], 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.delete(id);

    req.onsuccess = () => {
        // å‰Šé™¤ã«æˆåŠŸã—ãŸã‚‰ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        loadVideosFromDB();
    };

    req.onerror = (err) => {
        alert("å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + err);
    };
}

function loadToEditorFromLib(url) {
    fetch(url).then(r=>r.blob()).then(b=>{
        const f = new File([b], "temp", {type:"video/webm"});
        const dt = new DataTransfer(); dt.items.add(f);
        document.getElementById('editor-file-input').files = dt.files;
        loadEditorVideo(document.getElementById('editor-file-input'));
        document.querySelector('.editor-section').scrollIntoView({behavior:'smooth'});
    });
}

</script>
</body>
</html>
