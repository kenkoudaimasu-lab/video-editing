<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç”»ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ | å¥åº·ç§‘å­¦å¤§å­¦</title>
    <style>
        :root {
            --primary-color: #005f73; /* çŸ¥çš„ãªé’ç·‘ */
            --accent-color: #ee9b00; /* æ³¨æ„ã‚’å¼•ãã‚ªãƒ¬ãƒ³ã‚¸ */
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
        }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* Header */
        header {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .header-title { text-align: left; }
        header h1 { margin: 0; font-size: 1.2rem; }
        header p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.9; }
        
        /* Back Button */
        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* Main Layout */
        .workspace {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 95%;
            max-width: 1200px;
            flex-grow: 1;
            padding: 20px 0;
            gap: 15px;
            overflow-y: auto; /* å°ã•ã„ç”»é¢å¯¾å¿œ */
        }

        /* Canvas Container */
        .canvas-wrapper {
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            max-height: 55vh; /* ç”»é¢ã«åã‚ã‚‹ãŸã‚å°‘ã—èª¿æ•´ */
        }
        canvas {
            max-width: 100%;
            max-height: 55vh;
            display: block;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ“ãƒ‡ã‚ªã¯ã¡ã‚ƒã‚“ã¨è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«æ˜ç¤º */
        #studio-preview {
            display: block;
        }

        /* è£ã§å‹•ã‹ã™ã‚½ãƒ¼ã‚¹ç”¨ãƒ“ãƒ‡ã‚ªã¯ã€display:noneã§ã¯ãªãã€Œè¦‹ãˆãªã„ä½ç½®ã€ã«é…ç½®ã™ã‚‹ */
        #hidden-source-video {
            position: absolute;
            top: -9999px;
            left: -9999px;
            visibility: hidden;
        }

        /* Controls Panel */
        .controls {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
            border-right: 1px solid #eee;
            padding-right: 15px;
        }
        .control-group:last-child { border-right: none; padding-right: 0; }

        /* Buttons & Inputs */
        button {
            padding: 10px 16px;
            border: 1px solid #ccc;
            background: #f8f8f8;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button:hover { background: #e0e0e0; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        
        button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        button.record-btn { 
            background: #d00000; color: white; border-color: #b00000; 
            padding-left: 20px; padding-right: 20px;
        }
        button.record-btn:hover { background: #a00000; }
        button.record-btn.recording { 
            background: white; color: #d00000; border: 2px solid #d00000;
            animation: pulse 1.5s infinite; 
        }

        input[type="file"] { font-size: 0.9rem; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(208, 0, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(208, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(208, 0, 0, 0); } }

        /* Tooltip */
        .status-bar {
            font-size: 0.9rem;
            color: #555;
            background: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>å‹•ç”»ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³</h1>
        <p>å¥åº·ç§‘å­¦å¤§å­¦ æˆæ¥­å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ª</p>
    </div>
    <a href="#" class="back-btn" onclick="history.back(); return false;">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
</header>

<section id="screen-studio" class="screen-content">
  <div id="class-studio-section" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  ">
    <div style="background: #f3e5f5; padding: 15px 20px; border-bottom: 1px solid #e1bee7;">
      <h2 style="color: #4a148c; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
          ğŸ¥ æˆæ¥­å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ª
      </h2>
      <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
        æ•™æã‚„åˆ†æç”»é¢ã‚’æ“ä½œã—ãªãŒã‚‰éŸ³å£°ã‚’å¹ãè¾¼ã¿ã€æˆæ¥­å‹•ç”»ã‚’ä½œæˆã—ã¾ã™ã€‚<br>
        <strong>éŒ²ç”»ä¸­ã§ã‚‚å…±æœ‰ç”»é¢ã®å¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚</strong>
      </p>
    </div>

    <div style="padding: 20px;">
      
      <div style="margin-bottom: 20px; text-align: center;">
        <button onclick="startStudioScreenShare()" style="
          background: linear-gradient(135deg, #7b1fa2, #ba68c8); 
          color: white; border: none; padding: 15px 40px; 
          border-radius: 30px; font-weight: bold; font-size: 16px;
          cursor: pointer; display: inline-flex; align-items: center; gap: 10px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ğŸš€ ã‚¹ã‚¿ã‚¸ã‚ªã‚’é–‹å§‹ã™ã‚‹ (ç”»é¢é¸æŠ)
        </button>
        <p style="font-size:13px; color:#333; margin-top:10px; background:#e3f2fd; padding:10px; border-radius:6px; text-align:left;">
          <strong>ğŸ’¡ ç”»é¢å…¨ä½“ã‚’éŒ²ç”»ã™ã‚‹å ´åˆã®ã‚³ãƒ„:</strong><br>
          ã€Œç”»é¢å…¨ä½“ã€ã‚’é¸ã¶ã¨ã€ã“ã®ç”»é¢è‡ªä½“ãŒæ˜ ã‚Šè¾¼ã‚“ã§ã€Œåˆã‚ã›é¡ï¼ˆç„¡é™ãƒŸãƒ©ãƒ¼ï¼‰ã€ã«ãªã‚Šã¾ã™ã€‚<br>
          éŒ²ç”»ã‚’é–‹å§‹ã—ãŸã‚‰ã€æ“ä½œãƒ‘ãƒãƒ«ã® <span style="background:#555; color:white; padding:2px 6px; border-radius:4px;">ğŸ¥ Preview</span> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º(ğŸ™ˆ)</strong>ã«ã™ã‚‹ã¨ã€åˆã‚ã›é¡ã‚’é˜²ã„ã§ç¶ºéº—ã«éŒ²ç”»ã§ãã¾ã™ã€‚
        </p>
      </div>

      <div id="studio-container" style="
        max-width: 800px; margin: 0 auto; 
        background: #000; border-radius: 8px; 
        overflow: hidden; position: relative; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        display: flex; flex-direction: column;
      ">
        
        <div style="position: relative; flex: 1; background: #000; display: flex; align-items: center; justify-content: center; min-height: 400px;">
          <video id="studio-preview" playsinline muted autoplay style="width: 100%; height: 100%; max-height: 80vh; object-fit: contain;"></video>
          
          <div id="studio-rec-indicator" style="display:none; position: absolute; top: 20px; right: 20px; background: rgba(255, 0, 0, 0.9); color: white; padding: 6px 15px; border-radius: 4px; font-weight: bold; font-size: 14px; animation: blink 1s infinite; z-index: 20;">
            â— REC
          </div>
        </div>

        <div id="studio-controls" style="
          background: rgba(30, 30, 30, 0.95); 
          padding: 10px 15px; 
          display: flex; align-items: center; justify-content: space-between;
          border-top: 1px solid #444;
          flex-wrap: wrap; gap: 10px;
        ">
          
          <div style="display: flex; gap: 10px; align-items: center;">
            <div style="text-align: center;">
                <button id="btn-toggle-mic" onclick="toggleStudioMic()" disabled style="background:#444; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:not-allowed; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                    ğŸ¤
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Mic</span>
            </div>

            <div style="text-align: center;">
                <button id="btn-toggle-cam" onclick="toggleStudioCamera()" disabled style="background:#444; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:not-allowed; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                    ğŸ“·
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Cam</span>
            </div>

            <div style="text-align: center;">
                <button id="btn-change-screen" onclick="changeStudioSource()" disabled style="background:#0277bd; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:not-allowed; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                    ğŸ”„
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Change</span>
            </div>

            <div style="text-align: center;">
                <button id="btn-toggle-preview" onclick="toggleStudioPreview()" style="background:#555; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                    ğŸ¥
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Preview</span>
            </div>
          </div>

          <div style="flex: 1; margin: 0 15px; display: flex; flex-direction: column; justify-content: center; min-width: 80px;">
            <div style="display: flex; justify-content: space-between; color: #bbb; font-size: 10px; margin-bottom: 4px;">
              <span>Mic Level</span>
              <span id="mic-status-text">OFF</span>
            </div>
            <div style="background: #555; height: 6px; border-radius: 3px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);">
              <div id="audio-level-bar" style="width: 0%; height: 100%; background: linear-gradient(to right, #00e676, #ffeb3b, #ff1744); transition: width 0.05s;"></div>
            </div>
          </div>

          <div style="display: flex; gap: 15px; align-items: center;">
            <button onclick="toggleStudioFullScreen()" title="å…¨ç”»é¢è¡¨ç¤º" style="background:transparent; color:white; border:1px solid #777; padding:6px 10px; border-radius:6px; cursor:pointer; font-size: 16px;">
              â›¶
            </button>

            <button id="btn-studio-record" onclick="toggleStudioRecording()" disabled style="
              background: #ccc; color: white; border: none; 
              width: 54px; height: 54px; border-radius: 50%; 
              font-size: 20px; cursor: not-allowed; 
              display: flex; align-items: center; justify-content: center;
              box-shadow: 0 4px 8px rgba(0,0,0,0.3);
              transition: all 0.2s;
            ">
              â—
            </button>
          </div>
        </div>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="stopStudioStream()" id="btn-studio-stop-stream" style="display:none; background:#546e7a; color:white; border:none; padding:10px 30px; border-radius:6px; cursor:pointer; font-weight:bold;">
          â¹ çµ‚äº†ã™ã‚‹
        </button>
      </div>

      <video id="hidden-source-video" playsinline muted autoplay style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;"></video>
      <canvas id="studio-mixing-canvas" style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;"></canvas>
</div>
    </div>

<hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">
<div id="video-editor-area" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #e0f2f1; padding: 15px 20px; border-bottom: 1px solid #b2dfdb;">
    <h2 style="color: #00695c; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
       âœ‚ï¸ å‹•ç”»ç·¨é›†
    </h2>
    
  </div>

  <div style="padding: 20px;">
    
    <div style="margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #ccc;">
      <h4 style="margin-top:0; color:#00796b;">1. ç´ æå‹•ç”»ã‚’é¸æŠ</h4>
      <input type="file" id="editor-file-input" accept="video/*" onchange="loadEditorVideo(this)" style="width:100%;">
    </div>

    <div id="editor-controls" style="display:none;">
      
      <div style="display:flex; flex-wrap:wrap; gap:20px;">
        
        <div style="flex:1; min-width:250px; background:#fafafa; padding:15px; border-radius:8px; border:1px solid #ddd;">
          <h4 style="margin-top:0; color:#00796b; font-size:14px;">3. ãƒˆãƒªãƒŸãƒ³ã‚° (ç§’)</h4>
          <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px; font-size:13px;">
            <label>é–‹å§‹:<input type="number" id="trim-start" value="0" min="0" step="0.1" style="width:50px;"></label>
            <span>ï½</span>
            <label>çµ‚äº†:<input type="number" id="trim-end" value="0" min="0" step="0.1" style="width:50px;"></label>
          </div>
          <div style="display:flex; gap:5px;">
            <button onclick="setTrimCurrent('start')" style="background:#ddd; border:none; padding:4px 8px; font-size:11px; cursor:pointer; border-radius:4px; color:#333;">ç¾åœ¨åœ°ã‚’é–‹å§‹ã¸</button>
            <button onclick="setTrimCurrent('end')" style="background:#ddd; border:none; padding:4px 8px; font-size:11px; cursor:pointer; border-radius:4px; color:#333;">ç¾åœ¨åœ°ã‚’çµ‚äº†ã¸</button>
          </div>
        </div>
      </div>

      <div style="margin-top:15px; background:#fafafa; padding:15px; border-radius:8px; border:1px solid #ddd;">
          <h4 style="margin-top:0; color:#00796b; display:flex; align-items:center; gap:10px; font-size:14px;">
            4. åˆ†æç”¨ãƒã‚¹ã‚¯ (é»’å¡—ã‚Š)
            <button id="btn-editor-mask" onclick="toggleEditorMaskMode()" style="background:#424242; color:white; border:none; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:12px;">
              â¬› ã‚¨ãƒªã‚¢æŒ‡å®š
            </button>
            <button onclick="undoEditorMask()" style="background:#9e9e9e; color:white; border:none; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:12px;">
              â†© 1ã¤æ¶ˆã™
            </button>
            <button onclick="clearEditorMasks()" style="background:#d32f2f; color:white; border:none; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:12px;">
              ğŸ—‘ï¸ å…¨æ¶ˆå»
            </button>
            </h4>
          <p style="font-size:11px; color:#666; margin:0;">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€éš ã—ãŸã„ç¯„å›²ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„ã€‚ï¼ˆè¤‡æ•°æŒ‡å®šå¯èƒ½ï¼‰
          </p>
        </div>

      <div style="margin-top:20px; text-align:center;">
        <div style="position:relative; display:inline-block; border:2px solid #333; background:#000; margin-bottom:10px;">
          <canvas id="editor-canvas" style="max-width:100%; max-height:50vh; display:block; cursor:crosshair;"></canvas>
          <video id="editor-source-video" playsinline muted style="position:absolute; top:-9999px; left:-9999px; width:1px; height:1px; opacity:0; pointer-events:none;"></video>
        </div>

        <div style="margin-top: 5px; display: flex; align-items: center; gap: 10px; background: #eee; padding: 5px 10px; border-radius: 4px;">
            <span id="video-current-time" style="font-family: monospace; font-size: 14px; font-weight: bold;">00:00</span>
            <input type="range" id="video-seek-bar" value="0" min="0" step="0.1" style="flex: 1; cursor: pointer;" oninput="onSeekEditor(this.value)">
            <span id="video-total-time" style="font-family: monospace; font-size: 14px;">00:00</span>
        </div>
        
        <div style="display:flex; justify-content:center; gap:10px; margin-top: 10px;">
          <button onclick="previewEditorVideo()" style="background:#0288d1; color:white; padding:8px 20px; border:none; border-radius:4px; cursor:pointer;">â–¶ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ</button>
          <button onclick="stopEditorPreview()" style="background:#fbc02d; color:#333; padding:8px 20px; border:none; border-radius:4px; cursor:pointer;">â¸ åœæ­¢</button>
        </div>

        <div style="margin-top:20px; padding-top:15px; border-top:2px dashed #ccc;">
          <button id="btn-editor-export" onclick="startEditorExport()" style="background:#d32f2f; color:white; padding:12px 30px; border:none; border-radius:30px; font-size:15px; font-weight:bold; cursor:pointer; box-shadow:0 3px 5px rgba(0,0,0,0.2);">
            ğŸ¬ å‹•ç”»ã‚’ä½œæˆãƒ»ä¿å­˜
          </button>
          <p id="editor-status" style="margin-top:10px; font-size:13px; color:#e65100; font-weight:bold; min-height: 20px;"></p>
        </div>
      </div> 
    </div>
</div>

<hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">

<section id="library-section" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    width: 95%; max-width: 1200px; /* æ¨ªå¹…åˆã‚ã› */
">
  <div style="background: #e8eaf6; padding: 15px 20px; border-bottom: 1px solid #c5cae9;">
    <h2 style="color: #1a237e; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
        ğŸ“š å‹•ç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (ä¿å­˜æ¸ˆã¿)
    </h2>
    <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
      ä½œæˆãƒ»éŒ²ç”»ã—ãŸå‹•ç”»ã¯ã“ã“ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ï¼‰ã€‚<br>
      â€»ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨æ¶ˆãˆã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚
    </p>
  </div>

  <div style="padding: 20px;">
    <div id="video-library-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
      <p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">
        ä¿å­˜ã•ã‚ŒãŸå‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
      </p>
    </div>
  </div>
</section>
        

<script>
// ==========================================
// ğŸ¥ 1. æˆæ¥­å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ª (Studio) æ©Ÿèƒ½
// ==========================================

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let studioStream = null;       // ç”»é¢å…±æœ‰ã‚¹ãƒˆãƒªãƒ¼ãƒ 
let webcamStream = null;       // Webã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ 
let studioMixedStream = null;  // éŒ²ç”»ç”¨ãƒŸãƒƒã‚¯ã‚¹ã‚¹ãƒˆãƒªãƒ¼ãƒ 
let studioRecorder = null;     // éŒ²ç”»ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
let studioChunks = [];         // éŒ²ç”»ãƒ‡ãƒ¼ã‚¿
let isStudioRecording = false; // éŒ²ç”»ä¸­ãƒ•ãƒ©ã‚°
let studioAnimId = null;       // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ID
let audioContext = null;       // éŸ³å£°å‡¦ç†ç”¨
let studioMicNode = null;      // ãƒã‚¤ã‚¯éŸ³é‡åˆ¶å¾¡ç”¨

// DOMè¦ç´ 
const studioPreview = document.getElementById('studio-preview');
const hiddenSourceVideo = document.getElementById('hidden-source-video');
const mixingCanvas = document.getElementById('studio-mixing-canvas');
const mixingCtx = mixingCanvas ? mixingCanvas.getContext('2d') : null;
const levelBar = document.getElementById('audio-level-bar');

// å†…éƒ¨çŠ¶æ…‹
let isWebcamVisible = true;
let isMicMuted = false;

// --- ã‚¹ã‚¿ã‚¸ã‚ªé–‹å§‹ (ç”»é¢å…±æœ‰ + ãƒã‚¤ã‚¯) ---
async function startStudioScreenShare() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ç”»é¢å…±æœ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    try {
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆãƒã‚¤ã‚¯ & ã‚«ãƒ¡ãƒ©ï¼‰å–å¾—
        const userStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: { width: 320, height: 240, facingMode: "user" }
        });

        // ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯ã‚’åˆ†é›¢
        webcamStream = new MediaStream(userStream.getVideoTracks());
        const micStream = new MediaStream(userStream.getAudioTracks());

        // 2. ç”»é¢å…±æœ‰é–‹å§‹
        studioStream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "always" },
            audio: true // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°
        });

        // 3. æ˜ åƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (éš ã—ãƒ“ãƒ‡ã‚ªè¦ç´ ã«ã‚»ãƒƒãƒˆ)
        hiddenSourceVideo.srcObject = studioStream;
        await hiddenSourceVideo.play();

        // Canvasã‚µã‚¤ã‚ºåˆã‚ã›
        mixingCanvas.width = hiddenSourceVideo.videoWidth;
        mixingCanvas.height = hiddenSourceVideo.videoHeight;

        // 4. éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹ (ãƒã‚¤ã‚¯ + ã‚·ã‚¹ãƒ†ãƒ éŸ³)
        const mixedAudioTracks = await mixAudioStreams(micStream, studioStream);

        // 5. éŒ²ç”»ç”¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ä½œæˆ (Canvasæ˜ åƒ + ãƒŸãƒƒã‚¯ã‚¹éŸ³å£°)
        const canvasStream = mixingCanvas.captureStream(30); // 30fps
        if (mixedAudioTracks.length > 0) {
            canvasStream.addTrack(mixedAudioTracks[0]);
        }
        studioMixedStream = canvasStream;

        // 6. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        studioPreview.srcObject = studioMixedStream;
        
        // 7. æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹
        drawStudioFrame();
        
        // 8. UIæ›´æ–°
        updateStudioUI(true);
        initAudioMeter(micStream); // ãƒã‚¤ã‚¯ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼é–‹å§‹

        // ç”»é¢å…±æœ‰åœæ­¢æ™‚ã®å‡¦ç†
        studioStream.getVideoTracks()[0].onended = () => {
            stopStudioStream();
        };

    } catch (err) {
        console.error("Studio Error:", err);
        alert("ã‚¹ã‚¿ã‚¸ã‚ªã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    }
}

// --- æ˜ åƒåˆæˆãƒ«ãƒ¼ãƒ— (ç”»é¢ + ãƒ¯ã‚¤ãƒ—) ---
function drawStudioFrame() {
    if (!studioStream || !studioStream.active) return;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºæ›´æ–°ï¼ˆç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´ã«å¯¾å¿œï¼‰
    if (mixingCanvas.width !== hiddenSourceVideo.videoWidth) {
        mixingCanvas.width = hiddenSourceVideo.videoWidth;
        mixingCanvas.height = hiddenSourceVideo.videoHeight;
    }

    // A. èƒŒæ™¯ (ç”»é¢å…±æœ‰)
    mixingCtx.drawImage(hiddenSourceVideo, 0, 0, mixingCanvas.width, mixingCanvas.height);

    // B. ãƒ¯ã‚¤ãƒ— (Webã‚«ãƒ¡ãƒ©)
    if (isWebcamVisible && webcamStream) {
        // ç°¡æ˜“çš„ã«ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆã—ã¦ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—
        if (!window.tempWebcamVideo) {
            window.tempWebcamVideo = document.createElement('video');
            window.tempWebcamVideo.srcObject = webcamStream;
            window.tempWebcamVideo.muted = true;
            window.tempWebcamVideo.play();
        }

        const wipeW = mixingCanvas.width * 0.2; // ç”»é¢ã®20%
        const wipeH = (wipeW / 4) * 3;
        const margin = 20;
        const x = mixingCanvas.width - wipeW - margin;
        const y = mixingCanvas.height - wipeH - margin;

        mixingCtx.save();
        // å††å½¢ã‚¯ãƒªãƒƒãƒ—
        mixingCtx.beginPath();
        mixingCtx.arc(x + wipeW/2, y + wipeH/2, wipeH/2, 0, Math.PI * 2);
        mixingCtx.clip();
        mixingCtx.drawImage(window.tempWebcamVideo, x, y, wipeW, wipeH);
        // ç™½æ 
        mixingCtx.strokeStyle = "white";
        mixingCtx.lineWidth = 5;
        mixingCtx.stroke();
        mixingCtx.restore();
    }

    studioAnimId = requestAnimationFrame(drawStudioFrame);
}

// --- éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹å‡¦ç† ---
async function mixAudioStreams(micStream, sysStream) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const dest = audioContext.createMediaStreamDestination();

    // ãƒã‚¤ã‚¯å…¥åŠ›
    if (micStream.getAudioTracks().length > 0) {
        const micSrc = audioContext.createMediaStreamSource(micStream);
        studioMicNode = audioContext.createGain();
        studioMicNode.gain.value = 1.5; // ãƒã‚¤ã‚¯éŸ³é‡å¢—å¹…
        micSrc.connect(studioMicNode).connect(dest);
    }

    // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°å…¥åŠ›
    if (sysStream.getAudioTracks().length > 0) {
        const sysSrc = audioContext.createMediaStreamSource(sysStream);
        const sysGain = audioContext.createGain();
        sysGain.gain.value = 1.0;
        sysSrc.connect(sysGain).connect(dest);
    }

    return dest.stream.getAudioTracks();
}

// --- ãƒã‚¤ã‚¯ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼ ---
function initAudioMeter(stream) {
    if (!audioContext) return;
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    const src = audioContext.createMediaStreamSource(stream);
    src.connect(analyser);
    
    const buffer = new Uint8Array(analyser.frequencyBinCount);
    
    const updateMeter = () => {
        if (!studioStream || !studioStream.active) return;
        analyser.getByteFrequencyData(buffer);
        let sum = 0;
        for(let i=0; i<buffer.length; i++) sum += buffer[i];
        const avg = sum / buffer.length;
        
        // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯0è¡¨ç¤º
        const vol = (isMicMuted) ? 0 : Math.min(100, avg * 2); 
        if(levelBar) levelBar.style.width = vol + "%";
        
        requestAnimationFrame(updateMeter);
    };
    updateMeter();
}

// --- UIæ“ä½œ ---
function toggleStudioMic() {
    isMicMuted = !isMicMuted;
    if (studioMicNode) {
        studioMicNode.gain.value = isMicMuted ? 0 : 1.5;
    }
    const btn = document.getElementById('btn-toggle-mic');
    const status = document.getElementById('mic-status-text');
    if (isMicMuted) {
        btn.style.background = "#d32f2f";
        btn.innerHTML = "ğŸ”‡";
        status.textContent = "MUTE";
    } else {
        btn.style.background = "#444";
        btn.innerHTML = "ğŸ¤";
        status.textContent = "ON";
    }
}

function toggleStudioCamera() {
    isWebcamVisible = !isWebcamVisible;
    const btn = document.getElementById('btn-toggle-cam');
    if (isWebcamVisible) {
        btn.style.background = "#444";
        btn.innerHTML = "ğŸ“·";
    } else {
        btn.style.background = "#d32f2f";
        btn.innerHTML = "ğŸš«";
    }
}

// --- ç”»é¢å…±æœ‰ã®å¤‰æ›´ (Change) ---
async function changeStudioSource() {
    try {
        // 1. æ–°ã—ã„ç”»é¢å…±æœ‰ã‚’é–‹å§‹ï¼ˆé¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™ï¼‰
        const newStream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "always" },
            audio: true // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ã‚‚å–å¾—
        });

        // 2. ç¾åœ¨ã®ç”»é¢å…±æœ‰ï¼ˆå¤ã„æ–¹ï¼‰ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢
        if (studioStream) {
            const oldVideoTrack = studioStream.getVideoTracks()[0];
            if (oldVideoTrack) {
                oldVideoTrack.stop();
            }
        }

        // 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æ›´æ–°
        studioStream = newStream;

        // 4. è£ã§å‹•ã„ã¦ã„ã‚‹ãƒ“ãƒ‡ã‚ªã‚¿ã‚°ã®ã‚½ãƒ¼ã‚¹ã‚’å·®ã—æ›¿ãˆã‚‹
        const hiddenVideo = document.getElementById('hidden-source-video');
        hiddenVideo.srcObject = studioStream;
        await hiddenVideo.play();

        // 5. åœæ­¢æ™‚ã®å‡¦ç†ã‚’å†ç™»éŒ²
        studioStream.getVideoTracks()[0].onended = () => {
            stopStudioStream();
        };
        
        // â€»æ³¨æ„: éŒ²ç”»ä¸­ã®å ´åˆã€ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ï¼ˆPCã®éŸ³ï¼‰ã®åˆ‡ã‚Šæ›¿ãˆãŒå®Œå…¨ã«ã¯åæ˜ ã•ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€
        // æ˜ åƒã¯å³åº§ã«æ–°ã—ã„ç”»é¢ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚

    } catch (err) {
        console.log("ç”»é¢å¤‰æ›´ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ:", err);
    }
}

function toggleStudioPreview() {
    if (studioPreview.style.opacity === '0') {
        studioPreview.style.opacity = '1';
    } else {
        studioPreview.style.opacity = '0'; // åˆã‚ã›é¡é˜²æ­¢ã®ãŸã‚éè¡¨ç¤º
    }
}

function toggleStudioFullScreen() {
    const el = document.getElementById('studio-container');
    if (!document.fullscreenElement) {
        el.requestFullscreen().catch(e => alert("å…¨ç”»é¢ã‚¨ãƒ©ãƒ¼: " + e.message));
    } else {
        document.exitFullscreen();
    }
}

function updateStudioUI(isActive) {
    const btns = ['btn-toggle-mic', 'btn-toggle-cam', 'btn-change-screen', 'btn-studio-record'];
    btns.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.disabled = !isActive;
            el.style.cursor = isActive ? 'pointer' : 'not-allowed';
        }
    });
    document.getElementById('btn-studio-record').style.background = isActive ? '#d32f2f' : '#ccc';
    document.getElementById('btn-studio-stop-stream').style.display = isActive ? 'inline-block' : 'none';
}

// --- éŒ²ç”»åˆ¶å¾¡ ---
function toggleStudioRecording() {
    if (!isStudioRecording) {
        // éŒ²ç”»é–‹å§‹
        studioChunks = [];
        studioRecorder = new MediaRecorder(studioMixedStream, { mimeType: 'video/webm;codecs=vp9' });
        
        studioRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) studioChunks.push(e.data);
        };
        
        studioRecorder.onstop = saveStudioVideo;
        
        studioRecorder.start();
        isStudioRecording = true;
        
        // UIæ›´æ–°
        document.getElementById('studio-rec-indicator').style.display = 'block';
        document.getElementById('btn-studio-record').innerHTML = "â– ";
        document.getElementById('btn-studio-record').classList.add('recording');
        
    } else {
        // éŒ²ç”»åœæ­¢
        studioRecorder.stop();
        isStudioRecording = false;
        
        // UIæ›´æ–°
        document.getElementById('studio-rec-indicator').style.display = 'none';
        document.getElementById('btn-studio-record').innerHTML = "â—";
        document.getElementById('btn-studio-record').classList.remove('recording');
    }
}

function saveStudioVideo() {
    const blob = new Blob(studioChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Lesson_Video_${new Date().getTime()}.webm`;
    a.click();
    
    // â˜…ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜ã®ç¢ºèª
    if (confirm("å‹•ç”»ã‚’ã‚¢ãƒ—ãƒªå†…ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) {
        if(typeof saveVideoToDB === 'function') saveVideoToDB(blob, a.download);
    }
}

function stopStudioStream() {
    if (studioStream) studioStream.getTracks().forEach(t => t.stop());
    if (webcamStream) webcamStream.getTracks().forEach(t => t.stop());
    if (studioMixedStream) studioMixedStream.getTracks().forEach(t => t.stop());
    if (audioContext) audioContext.close();
    if (studioAnimId) cancelAnimationFrame(studioAnimId);
    
    studioPreview.srcObject = null;
    updateStudioUI(false);
}


// ==========================================
// âœ‚ï¸ 2. å‹•ç”»ç·¨é›† (Editor) æ©Ÿèƒ½
// ==========================================

let editorVideo = document.getElementById('editor-source-video');
let editorCanvas = document.getElementById('editor-canvas');
let editorCtx = editorCanvas ? editorCanvas.getContext('2d') : null;
let isEditorPreviewing = false;

let editorMasks = []; // ãƒã‚¹ã‚¯åº§æ¨™é…åˆ—
let isMasking = false;
let maskStart = null;
let editorAnimId = null;
let isExporting = false;

// --- å‹•ç”»èª­ã¿è¾¼ã¿ (ä¿®æ­£ç‰ˆ) ---
function loadEditorVideo(input) {
    const file = input.files[0];
    if (!file) return;
    
    const url = URL.createObjectURL(file);
    editorVideo.src = url;
    
    // 1. å‹•ç”»ã®åŸºæœ¬æƒ…å ±ï¼ˆé•·ã•ã‚„ã‚µã‚¤ã‚ºï¼‰ãŒã‚ã‹ã£ãŸæ™‚ç‚¹ã§ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    editorVideo.onloadedmetadata = () => {
        document.getElementById('editor-controls').style.display = 'block';
        
        document.getElementById('trim-start').value = 0;
        document.getElementById('trim-end').value = editorVideo.duration.toFixed(1);
        
        // ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®æœ€å¤§å€¤ã‚’å‹•ç”»ã®é•·ã•ã«åˆã‚ã›ã‚‹
        document.getElementById('video-seek-bar').max = editorVideo.duration;

        updateEditorCanvas();
        updateTimeDisplay(); // æ™‚é–“è¡¨ç¤ºã‚‚åˆæœŸåŒ–
    };
    
    // 2. æ˜ åƒãƒ‡ãƒ¼ã‚¿ãŒã€Œæç”»å¯èƒ½ã€ã«ãªã£ãŸã‚‰ã€ç¢ºå®Ÿã«æœ€åˆã®ç”»ã‚’è¡¨ç¤ºã—ã¦å¾…æ©Ÿ
    editorVideo.oncanplay = () => {
        editorVideo.currentTime = 0;
        drawEditorFrame();
        editorVideo.oncanplay = null; // é‡è¦ï¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’è§£é™¤
    };
    
    // ã‚·ãƒ¼ã‚¯ï¼ˆæ™‚é–“ç§»å‹•ï¼‰ã—ãŸæ™‚ã‚‚æç”»æ›´æ–°
    editorVideo.onseeked = () => drawEditorFrame();
}

// --- ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ ---
function onSeekEditor(val) {
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿä¸­ãªã‚‰æ­¢ã‚ã‚‹
    if (typeof isEditorPreviewing !== 'undefined' && isEditorPreviewing) {
        stopEditorPreview();
    }
    
    // å‹•ç”»ã®æ™‚é–“ã‚’å¤‰æ›´
    editorVideo.currentTime = val;
    
    // ç”»é¢ã‚’æ›´æ–°
    drawEditorFrame();
    updateTimeDisplay();
}

function updateTimeDisplay() {
    const cur = editorVideo.currentTime;
    const dur = editorVideo.duration || 0;
    
    // æ™‚é–“è¡¨ç¤ºã®æ›´æ–° (00:00å½¢å¼)
    const fmt = (s) => {
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const ss = Math.floor(s % 60).toString().padStart(2, '0');
        return `${m}:${ss}`;
    };
    
    document.getElementById('video-current-time').textContent = fmt(cur);
    document.getElementById('video-total-time').textContent = fmt(dur);
    
    // ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®ä½ç½®æ›´æ–° (æ“ä½œä¸­ã§ãªã„å ´åˆã®ã¿)
    const seekBar = document.getElementById('video-seek-bar');
    if (document.activeElement !== seekBar) {
        seekBar.value = cur;
    }
}


// --- ã‚­ãƒ£ãƒ³ãƒã‚¹æ›´æ–° ---
function updateEditorCanvas() {
    // æ¯”ç‡é¸æŠæ©Ÿèƒ½ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€å¸¸ã«æ¨ªé•·(16:9)ã§å›ºå®š
    editorCanvas.width = 1280; 
    editorCanvas.height = 720;
    
    drawEditorFrame();
}

function drawEditorFrame() {
    if (!editorCtx) return;
    
    // å‹•ç”»ã®æº–å‚™ãŒã§ãã¦ã„ãªã„ã€ã¾ãŸã¯ã‚µã‚¤ã‚ºãŒ0ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆå‰ã®çµµã‚’æ®‹ã™ï¼‰
    if (!editorVideo || editorVideo.videoWidth === 0) return;

    // 1. é»’èƒŒæ™¯ã§ã‚¯ãƒªã‚¢
    editorCtx.fillStyle = '#000';
    editorCtx.fillRect(0, 0, editorCanvas.width, editorCanvas.height);
    
    // 2. å‹•ç”»æç”»ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒãƒ•ã‚£ãƒƒãƒˆï¼‰
    // readyStateã®ãƒã‚§ãƒƒã‚¯ã‚’ç·©ã‚ã‚‹ (>= 2 ã§ã¯ãªã >= 1 ã§ã‚‚æç”»ã‚’è©¦ã¿ã‚‹)
    if (editorVideo.readyState >= 1) { 
        const scale = Math.min(
            editorCanvas.width / editorVideo.videoWidth,
            editorCanvas.height / editorVideo.videoHeight
        );
        const w = editorVideo.videoWidth * scale;
        const h = editorVideo.videoHeight * scale;
        const x = (editorCanvas.width - w) / 2;
        const y = (editorCanvas.height - h) / 2;
        
        editorCtx.drawImage(editorVideo, x, y, w, h);
    }
    
    // 3. ãƒã‚¹ã‚¯æç”»
    editorCtx.fillStyle = '#000';
    editorMasks.forEach(m => {
        editorCtx.fillRect(m.x, m.y, m.w, m.h);
    });
    
    // 4. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æ 
    if (isMasking && maskStart && currentMaskPos) {
        editorCtx.strokeStyle = 'yellow';
        editorCtx.lineWidth = 2;
        const r = getRect(maskStart, currentMaskPos);
        editorCtx.strokeRect(r.x, r.y, r.w, r.h);
    }

    // ç”»é¢æ›´æ–°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ™‚é–“è¡¨ç¤ºã‚‚æ›´æ–°ã™ã‚‹
    if (typeof updateTimeDisplay === 'function') {
        updateTimeDisplay();
    }
}

// --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ---
function previewEditorVideo() {
    // å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
    stopEditorPreview();
    isEditorPreviewing = true; // ãƒ•ãƒ©ã‚°ã‚’ON

    const start = parseFloat(document.getElementById('trim-start').value);
    const end = parseFloat(document.getElementById('trim-end').value);

    // é–‹å§‹ä½ç½®ã«ã‚»ãƒƒãƒˆ
    editorVideo.currentTime = start;

    // å†ç”Ÿé–‹å§‹
    editorVideo.play().then(() => {
        
        const loop = () => {
            // é‡è¦ï¼šãƒ•ãƒ©ã‚°ãŒOFFãªã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹
            if (!isEditorPreviewing) return;

            // çµ‚äº†åˆ¤å®š
            if (editorVideo.currentTime >= end || editorVideo.ended) {
                stopEditorPreview(); // çµ‚äº†ä½ç½®ã«æ¥ãŸã‚‰åœæ­¢å‡¦ç†ã‚’å‘¼ã¶
                return;
            }

            // æç”»
            drawEditorFrame();
            editorAnimId = requestAnimationFrame(loop);
        };

        loop();

    }).catch(error => {
        console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", error);
        alert("å‹•ç”»ã®å†ç”Ÿã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        isEditorPreviewing = false;
    });
}

function stopEditorPreview() {
    isEditorPreviewing = false; // ãƒ•ãƒ©ã‚°ã‚’OFF
    editorVideo.pause();
    if (editorAnimId) cancelAnimationFrame(editorAnimId);
}

function setTrimCurrent(type) {
    const val = editorVideo.currentTime.toFixed(1);
    document.getElementById(type === 'start' ? 'trim-start' : 'trim-end').value = val;
}

// --- ãƒã‚¹ã‚¯æ“ä½œ ---
let currentMaskPos = null;

function toggleEditorMaskMode() {
    isMasking = !isMasking;
    const btn = document.getElementById('btn-editor-mask');
    
    if (isMasking) {
        btn.style.background = '#d32f2f';
        btn.textContent = 'æŒ‡å®šä¸­...';
        // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
        editorCanvas.addEventListener('mousedown', onMaskDown);
        editorCanvas.addEventListener('mousemove', onMaskMove);
        editorCanvas.addEventListener('mouseup', onMaskUp);
    } else {
        btn.style.background = '#424242';
        btn.textContent = 'â¬› ã‚¨ãƒªã‚¢æŒ‡å®š';
        // ã‚¤ãƒ™ãƒ³ãƒˆè§£é™¤
        editorCanvas.removeEventListener('mousedown', onMaskDown);
        editorCanvas.removeEventListener('mousemove', onMaskMove);
        editorCanvas.removeEventListener('mouseup', onMaskUp);
    }
}

function getCanvasPos(e) {
    const rect = editorCanvas.getBoundingClientRect();
    const scaleX = editorCanvas.width / rect.width;
    const scaleY = editorCanvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

function onMaskDown(e) {
    maskStart = getCanvasPos(e);
    currentMaskPos = maskStart;
}
function onMaskMove(e) {
    if (!maskStart) return;
    currentMaskPos = getCanvasPos(e);
    drawEditorFrame();
}
function onMaskUp(e) {
    if (!maskStart) return;
    const r = getRect(maskStart, getCanvasPos(e));
    if (r.w > 10 && r.h > 10) {
        editorMasks.push(r);
    }
    maskStart = null;
    drawEditorFrame();
}
function getRect(p1, p2) {
    return {
        x: Math.min(p1.x, p2.x),
        y: Math.min(p1.y, p2.y),
        w: Math.abs(p1.x - p2.x),
        h: Math.abs(p1.y - p2.y)
    };
}
function undoEditorMask() { editorMasks.pop(); drawEditorFrame(); }
function clearEditorMasks() { editorMasks = []; drawEditorFrame(); }

// --- æ›¸ãå‡ºã— (Export) ---
function startEditorExport() {
    if (isExporting) return;
    isExporting = true;
    
    const start = parseFloat(document.getElementById('trim-start').value);
    const end = parseFloat(document.getElementById('trim-end').value);
    const duration = end - start;
    const btn = document.getElementById('btn-editor-export');
    const status = document.getElementById('editor-status');
    
    btn.disabled = true;
    
    // CanvaséŒ²ç”»
    const stream = editorCanvas.captureStream(30);
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
    const chunks = [];
    
    recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
    recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Edited_Video_${new Date().getTime()}.webm`;
        a.click();
        
        status.textContent = "âœ… å®Œäº†ã—ã¾ã—ãŸ";
        btn.disabled = false;
        isExporting = false;
        
        // â˜…ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜ã®ç¢ºèªï¼ˆã“ã“ã‚‚çµ±ä¸€ã—ã¾ã—ãŸï¼‰
        if(confirm("å‹•ç”»ã‚’ã‚¢ãƒ—ãƒªå†…ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) {
            if(typeof saveVideoToDB === 'function') saveVideoToDB(blob, a.download);
        }
    };
    
    recorder.start();
    editorVideo.currentTime = start;
    editorVideo.play();
    
    const recLoop = () => {
        if (!isExporting) return;
        drawEditorFrame();
        
        if (editorVideo.currentTime >= end || editorVideo.ended) {
            editorVideo.pause();
            recorder.stop();
            return;
        }
        
        const prog = Math.round(((editorVideo.currentTime - start) / duration) * 100);
        status.textContent = `â³ ä½œæˆä¸­... ${prog}%`;
        
        requestAnimationFrame(recLoop);
    };
    recLoop();
}

// ==========================================
// ğŸ“š 3. å‹•ç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (IndexedDB) æ©Ÿèƒ½
// ==========================================

const DB_NAME = 'SmartClassDB';
const DB_VERSION = 1;
const STORE_NAME = 'videos';
let db = null;

// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ– ---
function initLibraryDB() {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains(STORE_NAME)) {
            // ID(è‡ªå‹•é€£ç•ª), title, blob, date, size ã‚’ä¿å­˜
            d.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        loadVideosFromDB(); // åˆæœŸè¡¨ç¤º
    };

    request.onerror = (e) => {
        console.error("DB Error:", e);
    };
}

// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«DBã‚’é–‹ã
initLibraryDB();

// --- å‹•ç”»ã‚’ä¿å­˜ã™ã‚‹ (å¤–éƒ¨ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢æ•°) ---
function saveVideoToDB(blob, filename) {
    if (!db) return;

    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    
    const record = {
        title: filename || `Video_${new Date().toLocaleTimeString()}`,
        blob: blob,
        date: new Date().toLocaleString(),
        size: (blob.size / 1024 / 1024).toFixed(2) + ' MB'
    };

    const request = store.add(record);

    request.onsuccess = () => {
        // ä¿å­˜æˆåŠŸã—ãŸã‚‰ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã—ãŸï¼");
        loadVideosFromDB();
        
        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('library-section').scrollIntoView({ behavior: 'smooth' });
    };

    request.onerror = () => {
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    };
}

// --- ä¿å­˜æ¸ˆã¿å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º ---
function loadVideosFromDB() {
    if (!db) return;
    
    const container = document.getElementById('video-library-list');
    container.innerHTML = ''; // ã‚¯ãƒªã‚¢

    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.openCursor(null, 'prev'); // æ–°ã—ã„é †

    let count = 0;

    request.onsuccess = (e) => {
        const cursor = e.target.result;
        if (cursor) {
            count++;
            const data = cursor.value;
            const videoURL = URL.createObjectURL(data.blob);

            // ã‚«ãƒ¼ãƒ‰HTMLä½œæˆ
            const card = document.createElement('div');
            card.style.cssText = "background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:flex; flex-direction:column; gap:10px;";
            card.innerHTML = `
                <div style="position:relative; width:100%; padding-top:56.25%; background:#000; border-radius:4px; overflow:hidden;">
                    <video src="${videoURL}" controls style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain;"></video>
                </div>
                <div>
                    <h4 style="margin:0 0 5px 0; font-size:14px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${data.title}</h4>
                    <p style="margin:0; font-size:11px; color:#777;">ğŸ“… ${data.date} | ğŸ’¾ ${data.size}</p>
                </div>
                <div style="display:flex; gap:5px; margin-top:auto;">
                    <a href="${videoURL}" download="${data.title}" style="flex:1; text-align:center; background:#00897b; color:white; text-decoration:none; padding:6px; border-radius:4px; font-size:12px;">ğŸ“¥ ä¿å­˜</a>
                    <button onclick="deleteVideoFromDB(${data.id})" style="flex:1; background:#ef5350; color:white; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ—‘ï¸ å‰Šé™¤</button>
                    <button onclick="loadToEditorFromLib('${videoURL}')" style="flex:1; background:#f9a825; color:white; border:none; padding:6px; border-radius:4px; cursor:pointer; font-size:12px;">âœ‚ï¸ ç·¨é›†</button>
                </div>
            `;
            container.appendChild(card);
            
            cursor.continue();
        } else {
            if (count === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">ä¿å­˜ã•ã‚ŒãŸå‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }
        }
    };
}

// --- å‰Šé™¤æ©Ÿèƒ½ ---
function deleteVideoFromDB(id) {
    if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    store.delete(id);
    
    transaction.oncomplete = () => {
        loadVideosFromDB();
    };
}

// --- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ç·¨é›†ç”»é¢ã¸èª­ã¿è¾¼ã‚€æ©Ÿèƒ½ ---
function loadToEditorFromLib(blobUrl) {
    // BlobURLã‹ã‚‰Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¢¨ã«å¤‰æ›ã—ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã«æ¸¡ã™
    fetch(blobUrl)
        .then(res => res.blob())
        .then(blob => {
            // ã‚¨ãƒ‡ã‚£ã‚¿ã®videoè¦ç´ ã«ã‚»ãƒƒãƒˆ
            const videoEl = document.getElementById('editor-source-video');
            videoEl.src = URL.createObjectURL(blob);
            
            // ã‚¨ãƒ‡ã‚£ã‚¿UIã®è¡¨ç¤ºæ›´æ–°
            videoEl.onloadedmetadata = () => {
                document.getElementById('editor-controls').style.display = 'block';
                document.getElementById('trim-start').value = 0;
                document.getElementById('trim-end').value = videoEl.duration.toFixed(1);
                document.getElementById('video-seek-bar').max = videoEl.duration;
                if(typeof updateEditorCanvas === 'function') updateEditorCanvas();
                if(typeof updateTimeDisplay === 'function') updateTimeDisplay();
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                document.getElementById('video-editor-area').scrollIntoView({ behavior: 'smooth' });
            };
            
            videoEl.oncanplay = () => {
                videoEl.currentTime = 0;
                if(typeof drawEditorFrame === 'function') drawEditorFrame();
                videoEl.oncanplay = null;
            };
        });
}
</script>
</body>

</html>
